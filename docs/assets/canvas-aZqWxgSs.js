import{r as i,j as e,S as dt,R as q,b as $,g as lt,t as je,T as G,e as W,f as U,s as ct}from"./index-aluNvIa_.js";import{d as ne,u as Ie,e as ht,f as de,g as pt,h as Pe,P as X,i as ve,j as ut,k as $e,c as Ne,l as mt,S as ft,m as gt,n as Ze,o as xt,p as bt,q as yt,r as ze,s as jt,t as Tt,T as vt,v as Ct,w as kt,M as wt,x as It,y as Nt,L as St,z as Rt,A as Fe,B as Et,E as _t,F as re,G as Ot,H as Mt,J as He,K as we,N as Dt,O as Lt,Q as ge,U as zt,X as Ft,Y as Ht,Z as At,_ as Bt}from"./canvas-utils-spmIuIyC.js";import{B as ee}from"./label-DlpMCZQf.js";import{c as te,k as xe,K as be,u as Ve}from"./theme-provider-Do8CCq4V.js";import{B as Pt}from"./link-BefEORAU.js";import{u as $t}from"./colors-DsKDxiGc.js";import{D as Zt}from"./database-type-C2NNW5SW.js";/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=te("Magnet",[["path",{d:"m6 15-4-4 6.75-6.77a7.79 7.79 0 0 1 11 11L13 22l-4-4 6.39-6.36a2.14 2.14 0 0 0-3-3L6 15",key:"1i3lhw"}],["path",{d:"m5 8 4 4",key:"j6kj7e"}],["path",{d:"m12 15 4 4",key:"lnac28"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=te("Redo",[["path",{d:"M21 7v6h-6",key:"3ptur4"}],["path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7",key:"1kgawr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=te("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=te("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=te("Undo",[["path",{d:"M3 7v6h6",key:"1v2h90"}],["path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13",key:"1r6uu6"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=te("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=te("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);var qt=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","span","svg","ul"],Jt=qt.reduce((o,s)=>{const t=i.forwardRef((c,r)=>{const{asChild:h,...f}=c,u=h?dt:s;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(u,{...f,ref:r})});return t.displayName=`Primitive.${s}`,{...o,[s]:t}},{}),Qt="Separator",Ae="horizontal",es=["horizontal","vertical"],Ge=i.forwardRef((o,s)=>{const{decorative:t,orientation:c=Ae,...r}=o,h=ts(c)?c:Ae,u=t?{role:"none"}:{"aria-orientation":h==="vertical"?h:void 0,role:"separator"};return e.jsx(Jt.div,{"data-orientation":h,...u,...r,ref:s})});Ge.displayName=Qt;function ts(o){return es.includes(o)}var We=Ge;const Te=q.forwardRef(({className:o,orientation:s="horizontal",decorative:t=!0,...c},r)=>e.jsx(We,{ref:r,decorative:t,orientation:s,className:$("shrink-0 bg-border",s==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",o),...c}));Te.displayName=We.displayName;var ss=function o(s,t){if(s===t)return!0;if(s&&t&&typeof s=="object"&&typeof t=="object"){if(s.constructor!==t.constructor)return!1;var c,r,h;if(Array.isArray(s)){if(c=s.length,c!=t.length)return!1;for(r=c;r--!==0;)if(!o(s[r],t[r]))return!1;return!0}if(s.constructor===RegExp)return s.source===t.source&&s.flags===t.flags;if(s.valueOf!==Object.prototype.valueOf)return s.valueOf()===t.valueOf();if(s.toString!==Object.prototype.toString)return s.toString()===t.toString();if(h=Object.keys(s),c=h.length,c!==Object.keys(t).length)return!1;for(r=c;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,h[r]))return!1;for(r=c;r--!==0;){var f=h[r];if(!o(s[f],t[f]))return!1}return!0}return s!==s&&t!==t};const ye=lt(ss),os=({id:o,sourceX:s,sourceY:t,targetX:c,targetY:r,source:h,target:f,selected:u,data:N})=>{var M,D;const{getInternalNode:O,getEdge:y}=ne(),{openRelationshipFromSidebar:I,selectSidebarSection:E}=Ie(),{checkIfRelationshipRemoved:S,checkIfNewRelationship:C}=ht(),{relationships:T}=de(),l=N==null?void 0:N.relationship,_=i.useCallback(()=>{E("relationships"),I(o)},[o,I,E]),b=i.useMemo(()=>T.filter(k=>k.targetTableId===f&&k.sourceTableId===h||k.targetTableId===h&&k.sourceTableId===f).findIndex(k=>k.id===o),[T,o,h,f]),w=O(h),v=O(f),A=y(o),B=(D=(M=A==null?void 0:A.sourceHandle)==null?void 0:M.startsWith)!=null&&D.call(M,pt)?"right":"left",m=(w==null?void 0:w.measured.width)??0,L=B==="left"?s+3:s-m-10,z=B==="left"?s+m+9:s,Y=(v==null?void 0:v.measured.width)??0,F=c-1,V=c+Y+10,{sourceSide:K,targetSide:Z}=i.useMemo(()=>{const k={leftToLeft:Math.abs(L-F),leftToRight:Math.abs(L-V),rightToLeft:Math.abs(z-F),rightToRight:Math.abs(z-V)},ue=Math.min(k.leftToLeft,k.leftToRight,k.rightToLeft,k.rightToRight);switch(Object.keys(k).find(me=>k[me]===ue)){case"leftToRight":return{sourceSide:"left",targetSide:"right"};case"rightToLeft":return{sourceSide:"right",targetSide:"left"};case"rightToRight":return{sourceSide:"right",targetSide:"right"};default:return{sourceSide:"left",targetSide:"left"}}},[L,z,F,V]),[le]=i.useMemo(()=>Pe({sourceX:K==="left"?L:z,sourceY:t,targetX:Z==="left"?F:V,targetY:r,borderRadius:14,sourcePosition:K==="left"?X.Left:X.Right,targetPosition:Z==="left"?X.Left:X.Right,offset:(b+1)*14}),[K,Z,L,z,F,V,t,r,b]),ce=i.useMemo(()=>ve({cardinality:(l==null?void 0:l.sourceCardinality)??"one",selected:u??!1,side:K}),[l==null?void 0:l.sourceCardinality,u,K]),he=i.useMemo(()=>ve({cardinality:(l==null?void 0:l.targetCardinality)??"one",selected:u??!1,side:Z}),[l==null?void 0:l.targetCardinality,u,Z]),pe=i.useMemo(()=>l!=null&&l.id?C({relationshipId:l.id}):!1,[C,l==null?void 0:l.id]),se=i.useMemo(()=>l!=null&&l.id?S({relationshipId:l.id}):!1,[S,l==null?void 0:l.id]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:o,d:le,markerStart:`url(#${ce})`,markerEnd:`url(#${he})`,fill:"none",className:$(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-slate-400"}`,{"!stroke-green-500 !stroke-[3px]":pe,"!stroke-red-500 !stroke-[3px]":se}]),onClick:k=>{k.detail===2&&_()}}),e.jsx("path",{d:le,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:k=>{k.detail===2&&_()}})]})},Ue=q.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:$("rounded-xl border bg-card text-card-foreground shadow",o),...s}));Ue.displayName="Card";const ns=q.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:$("flex flex-col space-y-1.5 p-6",o),...s}));ns.displayName="CardHeader";const as=q.forwardRef(({className:o,...s},t)=>e.jsx("h3",{ref:t,className:$("font-semibold leading-none tracking-tight",o),...s}));as.displayName="CardTitle";const is=q.forwardRef(({className:o,...s},t)=>e.jsx("p",{ref:t,className:$("text-sm text-muted-foreground",o),...s}));is.displayName="CardDescription";const Ye=q.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:$("p-6 pt-0",o),...s}));Ye.displayName="CardContent";const rs=q.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:$("flex items-center p-6 pt-0",o),...s}));rs.displayName="CardFooter";const Q=q.forwardRef((o,s)=>{const{className:t,...c}=o;return e.jsx(ee,{ref:s,variant:"ghost",className:$("w-[36px] p-2 hover:bg-primary-foreground",t),...c})});Q.displayName=ee.displayName;function ds(o,s){const t=i.useRef();return i.useEffect(()=>(t.current=je(o,s),()=>{var r;(r=t.current)!=null&&r.cancel&&t.current.cancel()}),[o,s]),i.useCallback((...r)=>{var h;(h=t.current)==null||h.call(t,...r)},[])}const ls=()=>{const{getNodes:o,getViewport:s}=ne(),[t,c]=i.useState(!1),r=i.useCallback(()=>{var l,_;const f=o(),u=s();if(f.length===0){c(!1);return}const N=f.filter(b=>!b.hidden);if(N.length===0){c(!1);return}const O=-u.x/u.zoom,y=-u.y/u.zoom,I=((l=document.getElementById("canvas"))==null?void 0:l.clientWidth)||window.innerWidth,E=((_=document.getElementById("canvas"))==null?void 0:_.clientHeight)||window.innerHeight,S=O+I/u.zoom,C=y+E/u.zoom,T=N.some(b=>{var z;let w=b.width||0,v=b.height||0;if(b.type==="table"&&((z=b.data)!=null&&z.table)){const F=ut(b.data.table);w=F.width,v=F.height}const A=b.position.x,B=b.position.y,m=A+w,L=B+v;return m>=O&&A<=S&&L>=y&&B<=C});c(!T)},[o,s]),h=ds(r,1e3);return $e({onEnd:()=>{h()}}),{isLostInCanvas:t}},Be=o=>`${Math.round(o*100)}%`,cs=({readonly:o})=>{const{updateDiagramUpdatedAt:s}=de(),{t}=Ne(),{redo:c,undo:r,hasRedo:h,hasUndo:f}=mt(),{getZoom:u,zoomIn:N,zoomOut:O,fitView:y}=ne(),[I,E]=i.useState(Be(u())),{isLostInCanvas:S}=ls();$e({onChange:({zoom:w})=>{E(Be(w))}});const C=200,T=()=>{N({duration:C})},l=()=>{O({duration:C})},_=()=>{y({minZoom:1,maxZoom:1,duration:C})},b=i.useCallback(()=>{y({duration:500,padding:.1,maxZoom:.8})},[y]);return e.jsx("div",{className:"px-1",children:e.jsx(Ue,{className:"h-[44px] bg-secondary p-0 shadow-none",children:e.jsxs(Ye,{className:"flex h-full flex-row items-center p-1",children:[o?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:s,children:e.jsx(ft,{})})})}),e.jsxs(U,{children:[t("toolbar.save"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.SAVE_DIAGRAM].keyCombinationLabel})]})]}),e.jsx(Te,{orientation:"vertical"})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:b,className:S?"bg-pink-500 text-white hover:bg-pink-600 hover:text-white":"",children:e.jsx(Wt,{})})})}),e.jsxs(U,{children:[t("toolbar.show_all"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.SHOW_ALL].keyCombinationLabel})]})]}),e.jsx(Te,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:l,children:e.jsx(Xt,{})})})}),e.jsx(U,{children:t("toolbar.zoom_out")})]}),e.jsx(ee,{variant:"ghost",onClick:_,className:"w-[60px] p-2 hover:bg-primary-foreground",children:I}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:T,children:e.jsx(Kt,{})})})}),e.jsx(U,{children:t("toolbar.zoom_in")})]}),e.jsx(Te,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:r,disabled:!f,children:e.jsx(Yt,{})})})}),e.jsxs(U,{children:[t("toolbar.undo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.UNDO].keyCombinationLabel})]})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(Q,{onClick:c,disabled:!h,children:e.jsx(Gt,{})})})}),e.jsxs(U,{children:[t("toolbar.redo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.REDO].keyCombinationLabel})]})]})]})})})},hs=()=>{const{showCardinality:o}=Ve(),s={one:"1",many:"N"},t=["left","right"],c=[!0,!1];return o?e.jsx("svg",{className:"marker-definitions absolute left-0 top-0 z-0 size-0",children:e.jsx("defs",{children:Object.entries(s).map(([r,h])=>t.map(f=>c.map(u=>e.jsxs("marker",{id:ve({cardinality:r,selected:u,side:f}),viewBox:"0 0 16 16",markerWidth:"16",markerHeight:"16",refX:f==="left"?"15":"1",refY:"8",children:[e.jsx("circle",{cx:"8",cy:"8",r:"5",className:$([u?"fill-pink-600":"fill-muted-foreground","stroke-background","stroke-[0.5]"])}),e.jsx("text",{x:"7.9",y:"8.4",fontSize:"6",fontWeight:"600",textAnchor:"middle",dominantBaseline:"middle",className:"fill-muted",children:h})]},ve({cardinality:r,selected:u,side:f})))))})}):null},ps=({children:o})=>{const{createTable:s,filteredSchemas:t,schemas:c,readonly:r}=de(),{openCreateRelationshipDialog:h,openTableSchemaDialog:f}=gt(),{screenToFlowPosition:u}=ne(),{t:N}=Ne(),{isMd:O}=Ze("md"),y=i.useCallback(E=>{var C;const S=u({x:E.clientX,y:E.clientY});if(((t==null?void 0:t.length)??0)>1)f({onConfirm:T=>s({x:S.x,y:S.y,schema:T}),schemas:c.filter(T=>t==null?void 0:t.includes(T.id))});else{const T=(t==null?void 0:t.length)===1?(C=c.find(l=>l.id===t[0]))==null?void 0:C.name:void 0;s({x:S.x,y:S.y,schema:T})}},[s,u,f,c,t]),I=i.useCallback(()=>{h()},[h]);return!O||r?e.jsx(e.Fragment,{children:o}):e.jsxs(xt,{children:[e.jsx(bt,{children:o}),e.jsxs(yt,{children:[e.jsx(ze,{onClick:y,children:N("canvas_context_menu.new_table")}),e.jsx(ze,{onClick:I,children:N("canvas_context_menu.new_relationship")})]})]})},us=({id:o,sourceX:s,sourceY:t,targetX:c,targetY:r,source:h,target:f,selected:u})=>{const{getInternalNode:N}=ne(),{dependencies:O}=de(),{openDependencyFromSidebar:y,selectSidebarSection:I}=Ie(),E=i.useCallback(()=>{I("dependencies"),y(o)},[o,y,I]),S=i.useMemo(()=>O.filter(m=>m.tableId===f&&m.dependentTableId===h||m.tableId===h&&m.dependentTableId===f).findIndex(m=>m.id===o),[O,o,h,f]),C=N(h),T=N(f),{sourceTopY:l,sourceBottomY:_,targetTopY:b,targetBottomY:w}=i.useMemo(()=>{const m=(C==null?void 0:C.measured.height)??0,L=t+5,z=t+m+10,Y=(T==null?void 0:T.measured.height)??0,F=r+1,V=r+Y+5;return{sourceTopY:L,sourceBottomY:z,targetTopY:F,targetBottomY:V}},[C==null?void 0:C.measured.height,t,T==null?void 0:T.measured.height,r]),{sourceSide:v,targetSide:A}=i.useMemo(()=>{const m={topToTop:Math.abs(l-b),topToBottom:Math.abs(l-w),bottomToTop:Math.abs(_-b),bottomToBottom:Math.abs(_-w)},L=Math.min(m.topToTop,m.topToBottom,m.bottomToTop,m.bottomToBottom);switch(Object.keys(m).find(Y=>m[Y]===L)){case"topToBottom":return{sourceSide:"top",targetSide:"bottom"};case"bottomToTop":return{sourceSide:"bottom",targetSide:"top"};case"bottomToBottom":return{sourceSide:"bottom",targetSide:"bottom"};default:return{sourceSide:"top",targetSide:"top"}}},[l,_,b,w]),[B]=i.useMemo(()=>Pe({sourceX:s,sourceY:v==="top"?l:_,targetX:c,targetY:A==="top"?b:w,borderRadius:14,sourcePosition:v==="top"?X.Top:X.Bottom,targetPosition:A==="top"?X.Top:X.Bottom,offset:(S+1)*14}),[S,_,v,l,s,w,A,b,c]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:o,d:B,fill:"none",className:$(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-blue-400"}`]),onClick:m=>{m.detail===2&&E()}}),e.jsx("path",{d:B,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:m=>{m.detail===2&&E()}})]})},ms={"relationship-edge":os,"dependency-edge":us},fs=[],ke=(o,s)=>({id:o.id,type:"table",position:{x:o.x,y:o.y},data:{table:o,isOverlapping:!1},width:o.width??wt,hidden:!we(o,s)}),Cs=({initialTables:o})=>{const{getEdge:s,getInternalNode:t,getEdges:c,getNode:r}=ne(),[h,f]=i.useState([]),[u,N]=i.useState([]),{toast:O}=jt(),{t:y}=Ne(),{tables:I,relationships:E,createRelationship:S,createDependency:C,updateTablesState:T,removeRelationships:l,removeDependencies:_,getField:b,databaseType:w,filteredSchemas:v,events:A,dependencies:B,readonly:m}=de(),{showSidePanel:L}=Ie(),{effectiveTheme:z}=$t(),{scrollAction:Y,showDependenciesOnCanvas:F,showMiniMapOnCanvas:V}=Ve(),{showAlert:K}=Tt(),{isMd:Z}=Ze("md"),le=i.useMemo(()=>({table:vt}),[]),[ce,he]=i.useState(!1),{reorderTables:pe,fitView:se,setOverlapGraph:M,overlapGraph:D}=Ct(),[k,ue]=i.useState(!0),[H,me,Se]=kt(o.map(a=>ke(a,v))),[Ce,fe,Re]=It(fs),[Ee,Ke]=i.useState(!1);i.useEffect(()=>{ue(!0)},[o]),i.useEffect(()=>{const a=o.map(d=>ke(d,v));ye(a,H)&&ue(!1)},[o,H,v]),i.useEffect(()=>{k||je(()=>{se({duration:200,padding:.1,maxZoom:.8})},500)()},[k,se]),i.useEffect(()=>{const a=E.reduce((n,g)=>(n[`${g.targetTableId}${g.targetFieldId}`]=0,n),{}),d=B.reduce((n,g)=>(n[g.tableId]=0,n),{});fe([...E.map(n=>({id:n.id,source:n.sourceTableId,target:n.targetTableId,sourceHandle:`${St}${n.sourceFieldId}`,targetHandle:`${Nt}${a[`${n.targetTableId}${n.targetFieldId}`]++}_${n.targetFieldId}`,type:"relationship-edge",data:{relationship:n}})),...B.map(n=>({id:n.id,source:n.dependentTableId,target:n.tableId,sourceHandle:`${Fe}${n.dependentTableId}`,targetHandle:`${Rt}${d[n.tableId]++}_${n.tableId}`,type:"dependency-edge",data:{dependency:n},hidden:!F&&w!==Zt.CLICKHOUSE}))])},[E,B,fe,F,w]),i.useEffect(()=>{const a=H.filter(d=>d.selected).map(d=>d.id);ye(a,h)||f(a)},[H,f,h]),i.useEffect(()=>{const a=Ce.filter(d=>d.selected).map(d=>d.id);ye(a,u)||N(a)},[Ce,N,u]),i.useEffect(()=>{const d=[...c().filter(n=>h.includes(n.source)||h.includes(n.target)).map(n=>n.id),...u];fe(n=>n.map(g=>{const x=d.includes(g.id);if(g.type==="dependency-edge"){const j=g;return{...j,data:{...j.data,highlighted:x},animated:x,zIndex:x?1:0}}else{const j=g;return{...j,data:{...j.data,highlighted:x},animated:x,zIndex:x?1:0}}}))},[u,h,fe,c]),i.useEffect(()=>{me(I.map(a=>{const d=(D.graph.get(a.id)??[]).length>0,n=ke(a,v);return{...n,data:{...n.data,isOverlapping:d,highlightOverlappingTables:ce}}}))},[I,me,v,D.lastUpdated,D.graph,ce]);const _e=i.useRef(void 0);i.useEffect(()=>{ye(v,_e.current)||(je(()=>{const a=He({tables:I.filter(d=>we(d,v))});M(a),se({duration:500,padding:.1,maxZoom:.8})},500)(),_e.current=v)},[v,se,I,M]);const Xe=i.useCallback(async a=>{var R,P,J,ae,ie,oe,De,Le;if((P=(R=a.sourceHandle)==null?void 0:R.startsWith)!=null&&P.call(R,Fe)||(ae=(J=a.sourceHandle)==null?void 0:J.startsWith)!=null&&ae.call(J,Et)){const it=a.target,rt=a.source;C({tableId:it,dependentTableId:rt});return}const d=a.source,n=a.target,g=((oe=(ie=a.sourceHandle)==null?void 0:ie.split("_"))==null?void 0:oe.pop())??"",x=((Le=(De=a.targetHandle)==null?void 0:De.split("_"))==null?void 0:Le.pop())??"",j=b(d,g),p=b(n,x);if(!(!j||!p)){if(!_t(j.type,p.type,w)){O({title:"Field types are not compatible",variant:"destructive",description:"Relationships can only be created between compatible field types"});return}S({sourceTableId:d,targetTableId:n,sourceFieldId:g,targetFieldId:x})}},[S,C,b,O,w]),qe=i.useCallback(a=>{let d=a;m&&(d=d.filter(p=>p.type!=="remove"));const g=d.filter(p=>p.type==="remove").map(p=>s(p.id)).filter(p=>!!p),x=g.filter(p=>(p==null?void 0:p.type)==="relationship-edge").map(p=>{var R,P;return(P=(R=p==null?void 0:p.data)==null?void 0:R.relationship)==null?void 0:P.id}),j=g.filter(p=>(p==null?void 0:p.type)==="dependency-edge").map(p=>{var R,P;return(P=(R=p==null?void 0:p.data)==null?void 0:R.dependency)==null?void 0:P.id});return x.length>0&&l(x),j.length>0&&_(j),Re(d)},[s,Re,l,_,m]),Je=i.useCallback(({positionChanges:a,sizeChanges:d})=>{if(a.length>0||d.length>0){let n=D;for(const g of a)n=re({node:r(g.id)},{nodes:H.filter(x=>!x.hidden)},n);for(const g of d)n=re({node:r(g.id)},{nodes:H.filter(x=>!x.hidden)},n);M(n)}},[H,D,M,r]),Oe=je(Je,200),Qe=i.useCallback(a=>{let d=a;m&&(d=d.filter(j=>j.type!=="remove"));const n=d.filter(j=>j.type==="position"&&!j.dragging),g=d.filter(j=>j.type==="remove"),x=d.filter(j=>j.type==="dimensions"&&j.resizing);return(n.length>0||g.length>0||x.length>0)&&T(j=>j.map(p=>{var J,ae,ie;const R=n.find(oe=>oe.id===p.id),P=x.find(oe=>oe.id===p.id);return R||P?{id:p.id,...R?{x:(J=R.position)==null?void 0:J.x,y:(ae=R.position)==null?void 0:ae.y}:{},...P?{width:((ie=P.dimensions)==null?void 0:ie.width)??p.width}:{}}:p}).filter(p=>!g.some(R=>R.id===p.id))),Oe({positionChanges:n,sizeChanges:x}),Se(d)},[Se,T,Oe,m]),et=i.useCallback(a=>{let d=D;if(a.action==="add_tables"){for(const n of a.data.tables)d=re({node:r(n.id)},{nodes:H.filter(g=>!g.hidden)},D);M(d)}else if(a.action==="remove_tables"){for(const n of a.data.tableIds)d=Ot(d,n);M(d)}else if(a.action==="update_table"&&a.data.table.width){const n=r(a.data.id),g={...n.measured,width:a.data.table.width};d=re({node:{...n,measured:g}},{nodes:H.filter(x=>!x.hidden)},D),M(d)}else if(a.action==="add_field"||a.action==="remove_field"){const n=r(a.data.tableId),g={...n.measured??{},height:Mt(a.data.fields.length)};d=re({node:{...n,measured:g}},{nodes:H.filter(x=>!x.hidden)},D),M(d)}else if(a.action==="load_diagram"){const n=a.data.diagram.tables??[],g=He({tables:n.filter(x=>we(x,v))});M(g)}},[D,M,r,H,v]);A.useSubscription(et);const tt=I.length>0?!t(I[0].id):!1,st=i.useCallback(()=>{K({title:y("reorder_diagram_alert.title"),description:y("reorder_diagram_alert.description"),actionLabel:y("reorder_diagram_alert.reorder"),closeLabel:y("reorder_diagram_alert.cancel"),onAction:pe})},[y,K,pe]),ot=i.useMemo(()=>Array.from(D.graph).some(([,a])=>a.length>0),[D]),nt=i.useCallback(()=>{he(!0),setTimeout(()=>he(!1),600)},[]),Me=Dt("Shift"),at=ct();return e.jsx(ps,{children:e.jsxs("div",{className:"relative flex h-full",id:"canvas",children:[e.jsxs(Lt,{colorMode:z,className:"canvas-cursor-default nodes-animated",nodes:H,edges:Ce,onNodesChange:Qe,onEdgesChange:qe,maxZoom:5,minZoom:.1,onConnect:Xe,proOptions:{hideAttribution:!0},fitView:!1,nodeTypes:le,edgeTypes:ms,defaultEdgeOptions:{animated:!1,type:"relationship-edge"},panOnScroll:Y==="pan",snapToGrid:Me||Ee,snapGrid:[20,20],children:[e.jsx(ge,{position:"top-left",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 md:flex-row",children:[m?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{variant:"secondary",className:"size-8 p-1 shadow-none",onClick:st,children:e.jsx(zt,{className:"size-4"})})})}),e.jsx(U,{children:y("toolbar.reorder_diagram")})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{variant:"secondary",className:$("size-8 p-1 shadow-none",Ee||Me?"bg-pink-600 text-white hover:bg-pink-500 dark:hover:bg-pink-700 hover:text-white":""),onClick:()=>Ke(a=>!a),children:e.jsx(Vt,{className:"size-4"})})})}),e.jsx(U,{children:y("snap_to_grid_tooltip",{key:at==="mac"?"â‡§":"Shift"})})]})]}),e.jsx("div",{className:`transition-opacity duration-300 ease-in-out ${ot?"opacity-100":"opacity-0"}`,children:e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{variant:"default",className:"size-8 p-1 shadow-none",onClick:nt,children:e.jsx(Ut,{className:"size-4 text-white"})})})}),e.jsx(U,{children:y("toolbar.highlight_overlapping_tables")})]})})]})}),tt?e.jsx(ge,{position:"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(Pt,{variant:"default",className:"bg-pink-600 text-white",children:y("loading_diagram")})}):null,!Z&&!m?e.jsx(ge,{position:"bottom-left",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(ee,{className:"size-11 bg-pink-600 p-2 hover:bg-pink-500",onClick:L,children:e.jsx(Ft,{})})}):null,e.jsx(ge,{position:Z?"bottom-center":"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(cs,{readonly:m})}),V&&e.jsx(Ht,{style:{width:Z?100:60,height:Z?100:60}}),e.jsx(At,{variant:Bt.Dots,gap:16,size:1})]}),e.jsx(hs,{})]})})};export{Cs as C,Te as S};
